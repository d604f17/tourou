{"version":3,"sources":["../../src/mmas/Colony.js"],"names":["Colony","params","_graph","_colony","_colonySize","_alpha","_beta","_rho","_q","_initPheromone","_type","_elitistWeight","_maxIterations","_minScalingFactor","_maxDistance","_iteration","_minPheromone","_maxPheromone","_iterationBest","_globalBest","_createAnts","length","antIndex","push","resetAnts","setInitialPheromone","resetPheromone","edges","getEdges","edgeIndex","size","ready","writeWaitingPercent","p","m","clearLine","process","stdout","cursorTo","write","times","start","Date","getTime","step","end","averageTimePerIteration","reduce","a","b","timeLeft","percentage","Math","round","minutes","toFixed","console","log","run","getGlobalBest","updatePheromone","best","pheromone","getPheromone","setPheromone","getIterationBest","getTour","distance","addPheromone","bestIndex","bestValue","value","bestAnt"],"mappings":"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","file":"Colony.js","sourcesContent":["import readline from 'readline';\nimport Graph from './Graph';\nimport Ant from './Ant';\n\nclass Colony {\n  constructor(params) {\n    this._graph = new Graph();\n    this._colony = [];\n\n    // Set default params\n    this._colonySize = params && params['colonySize'] ? params['colonySize'] : 30;\n    this._alpha = params && params['alpha'] ? params['alpha'] : 1;\n    this._beta = params && params['beta'] ? params['beta'] : 3;\n    this._rho = params && params['rho'] ? params['rho'] : 0.1;\n    this._q = params && params['q'] ? params['q'] : 1;\n    this._initPheromone = params && params['initPheromone'] ? params['initPheromone'] : this._q;\n    this._type = 'maxmin'; //acs\n    this._elitistWeight = params && params['elitistWeight'] ? params['elitistWeight'] : 0;\n    this._maxIterations = params && params['maxIterations'] ? params['maxIterations'] : 200;\n    this._minScalingFactor = params && params['minScalingFactor'] ?params['minScalingFactor'] :0.001;\n    this._maxDistance = params && params['maxDistance'] ?params['maxDistance'] : 20000;\n\n    this._iteration = 0;\n    this._minPheromone = null;\n    this._maxPheromone = null;\n\n    this._iterationBest = null;\n    this._globalBest = null;\n\n    this._createAnts();\n  }\n\n  getGraph() {\n    return this._graph;\n  }\n\n  getAnts() {\n    return this._colony;\n  }\n\n  size() {\n    return this._colony.length;\n  }\n\n  currentIteration() {\n    return this._iteration;\n  }\n\n  maxIterations() {\n    return this._maxIterations;\n  }\n\n  _createAnts() {\n    this._colony = [];\n    for (var antIndex = 0; antIndex < this._colonySize; antIndex++) {\n      this._colony.push(new Ant(this._graph, {\n        'alpha': this._alpha,\n        'beta': this._beta,\n        'q': this._q,\n        'maxDistance': this._maxDistance,\n      }));\n    }\n  }\n\n  reset() {\n    this._iteration = 0;\n    this._globalBest = null;\n    this.resetAnts();\n    this.setInitialPheromone(this._initPheromone);\n    this._graph.resetPheromone();\n  }\n\n  setInitialPheromone() {\n    const edges = this._graph.getEdges();\n    for (var edgeIndex in edges) {\n      edges[edgeIndex].setInitialPheromone(this._initPheromone);\n    }\n  }\n\n  resetAnts() {\n    this._createAnts();\n    this._iterationBest = null;\n  }\n\n  ready() {\n    return this._graph.size() > 1;\n  }\n\n  run() {\n    if (!this.ready()) {\n      return;\n    }\n\n    this._iteration = 0;\n\n    function writeWaitingPercent(p, m) {\n      readline.clearLine(process.stdout);\n      readline.cursorTo(process.stdout, 0);\n      process.stdout.write(`running mmas ${p}% - ${m} minutes left. `);\n    }\n\n    let times = [];\n\n    while (this._iteration < this._maxIterations) {\n      var start = new Date().getTime();\n      this.step();\n      var end = new Date().getTime();\n      times.push(end - start);\n\n      let averageTimePerIteration = times.reduce((a, b) => a + b) / times.length;\n      let timeLeft = (this._maxIterations - this._iteration) * averageTimePerIteration;\n      let percentage = Math.round((this._iteration / this._maxIterations) * 100);\n      let minutes = ((timeLeft / 1000) / 60).toFixed(2);\n\n      writeWaitingPercent(percentage, minutes);\n    }\n    console.log('');\n  }\n\n  step() {\n    if (!this.ready() || this._iteration >= this._maxIterations) {\n      return;\n    }\n\n    this.resetAnts();\n\n    for (var antIndex in this._colony) {\n      this._colony[antIndex].run();\n    }\n\n    this.getGlobalBest();\n    this.updatePheromone();\n\n    this._iteration++;\n  }\n\n  updatePheromone() {\n    const edges = this._graph.getEdges();\n    let best;\n\n    for (var edgeIndex in edges) {\n      const pheromone = edges[edgeIndex].getPheromone();\n      edges[edgeIndex].setPheromone(pheromone * (1 - this._rho));\n    }\n\n    if (this._type == 'maxmin') {\n      if ((this._iteration / this._maxIterations) > 0.75) { //0.75\n        best = this.getGlobalBest();\n      } else {\n        best = this.getIterationBest();\n      }\n\n      // Set maxmin\n      this._maxPheromone = this._q / best.getTour().distance();\n      this._minPheromone = this._maxPheromone * this._minScalingFactor;\n\n      best.addPheromone();\n    } else {\n      for (var antIndex in this._colony) {\n        this._colony[antIndex].addPheromone();\n      }\n    }\n\n    if (this._type == 'elitist') {\n      this.getGlobalBest().addPheromone(this._elitistWeight);\n    }\n\n    if (this._type == 'maxmin') {\n      for (var edgeIndex in edges) {\n        const pheromone = edges[edgeIndex].getPheromone();\n        if (pheromone > this._maxPheromone) {\n          edges[edgeIndex].setPheromone(this._maxPheromone);\n        } else if (pheromone < this._minPheromone) {\n          edges[edgeIndex].setPheromone(this._minPheromone);\n        }\n      }\n    }\n  }\n\n  getIterationBest() {\n    if (this._colony[0].getTour() == null) {\n      return null;\n    }\n\n    if (this._iterationBest == null) {\n      let bestIndex = 0;\n      let bestValue = this._colony[bestIndex].getTour().value;\n\n      for (var antIndex in this._colony) {\n        const value = this._colony[antIndex].getTour().value;\n        if (value > bestValue) {\n          bestIndex = antIndex;\n          bestValue = value;\n        }\n      }\n\n      this._iterationBest = this._colony[bestIndex];\n    }\n\n    return this._iterationBest;\n  }\n\n  getGlobalBest() {\n    const bestAnt = this.getIterationBest();\n    if (bestAnt == null && this._globalBest == null) {\n      return null;\n    }\n\n    if (bestAnt != null) {\n      if (this._globalBest == null ||\n          this._globalBest.getTour().value >= bestAnt.getTour().value) {\n        this._globalBest = bestAnt;\n      }\n    }\n\n    return this._globalBest;\n  }\n}\n\nexport default Colony;"]}